{# catalog/templates/catalog/catalog_selection.html #}
{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Каталог продукции{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/catalog_style.css' %}">
{% endblock %}

{% block content %}
    <h2>Каталог продукции</h2>

    {# Сообщения Django будут отображаться автоматически из base.html #}

    <div class="catalog-container">

        {# --- Блок с иерархическим каталогом (без изменений) --- #}
        <div class="catalog-tree">
            <h3>Продукция</h3>
            {# ... ваш код дерева каталога ... #}
            <ul>
                {% for category, products_dict in structured_catalog.items %}
                    <li class="category-item">
                        <span class="toggle-icon collapsed">►</span>
                        <span class="toggle-text category-name">{{ category.name }}</span>
                        <div class="category-content collapsible collapsed">
                            <ul class="product-list-in-category">
                                {% for product, models_list in products_dict.items %}
                                    <li class="product-item">
                                        <span class="toggle-icon collapsed">►</span>
                                        <span class="toggle-text product-name">{{ product.name }}</span>
                                        <div class="product-content collapsible collapsed">
                                            <ul class="model-list-in-product">
                                                {% for model in models_list %}
                                                    <li class="model-item" data-model-id="{{ model.id }}">
                                                        <h6>Модель: {{ model.name }}</h6>
                                                        <p>Цена: {{ model.price|floatformat:2 }} руб.</p>
                                                        <form class="selection-form ajax-update-form">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="model_id" value="{{ model.id }}">
                                                            <label for="quantity_{{ model.id }}">Кол-во:</label>
                                                            <input type="number"
                                                                   id="quantity_{{ model.id }}"
                                                                   name="quantity"
                                                                   value="{{ selection|get_item:model.id|default:0 }}"
                                                                   min="0"
                                                                   class="quantity-input">
                                                            <button type="button" class="ajax-update-button" data-action="set" title="Установить количество">OK</button>
                                                        </form>
                                                        <div class="quick-update-buttons">
                                                             <button type="button" class="ajax-update-button small-button" data-action="add" data-model-id="{{ model.id }}" title="Добавить 1 шт.">+</button>
                                                             <button type="button" class="ajax-update-button small-button" data-action="remove" data-model-id="{{ model.id }}" title="Удалить 1 шт.">-</button>
                                                        </div>
                                                        {% if model.details %}
                                                             <div class="model-details"><h6>Описание:</h6><p>{{ model.details|linebreaksbr }}</p></div>
                                                        {% endif %}
                                                        {% if model.image %}
                                                            <div class="model-image-container"><img src="{{ model.image.url }}" alt="{{ model.name }}"></div>
                                                        {% endif %}
                                                    </li>
                                                {% empty %}<li>Нет доступных моделей в этом продукте.</li>{% endfor %}
                                            </ul>
                                        </div>
                                    </li>
                                {% empty %}<li>Нет доступных продуктов в этой категории.</li>{% endfor %}
                            </ul>
                        </div>
                    </li>
                {% empty %}<li>Каталог пуст.</li>{% endfor %}
            </ul>
        </div>

        {# --- Блок с текущим выбором и кнопками генерации документов --- #}
        <div class="selection-summary">
            <h3>Ваш выбор</h3>
            <div class="selection-summary-content"> {# Контейнер для AJAX обновления summary #}
                {% if selected_items %}
                    <table>
                        <thead>
                            <tr>
                                <th>Наименование</th>
                                <th>Кол-во</th>
                                <th>Цена за ед.</th>
                                <th>Сумма</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in selected_items %}
                                <tr data-model-id="{{ item.model.id }}">
                                    <td>{{ item.model.product.name }} - {{ item.model.name }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>{{ item.unit_price|floatformat:2 }}</td>
                                    <td>{{ item.item_total|floatformat:2 }}</td>
                                    <td>
                                         <button type="button" class="remove-all-button ajax-update-button small-button" data-action="remove_all" data-model-id="{{ item.model.id }}" title="Удалить позицию полностью">x</button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                             <tr>
                                 <td colspan="3" style="text-align:right;"><strong>Итого:</strong></td>
                                 <td class="total-price-cell"><strong>{{ total_price|floatformat:2 }}</strong></td>
                                 <td></td>
                             </tr>
                        </tfoot>
                    </table>

                    {# === ИЗМЕНЕНО: ДОБАВЛЕНЫ НОВЫЕ КНОПКИ === #}
                    <div class="document-buttons">
                        {# Кнопка очистки всего выбора (AJAX) #}
                        <button type="button" class="button button-clear ajax-update-button" data-action="clear" title="Очистить весь выбор" onclick="return confirm('Вы уверены, что хотите очистить весь выбор?');">Очистить выбор</button>

                        {# Основная кнопка КП (стандартная ссылка) #}
                        <a href="{% url 'generate_commercial_offer_docx' %}" class="button">Сформировать КП</a> {# Возможно, переименовать "КП (DOCX)" в просто "КП" или "КП (Основной)" #}

                        {# НОВАЯ КНОПКА для КП Учебный мир #}
                        <a href="{% url 'generate_commercial_offer_umed_docx' %}" class="button">КП Учебный мир</a>

                        {# НОВАЯ КНОПКА для КП ПОС78 #}
                        <a href="{% url 'generate_commercial_offer_pos78_docx' %}" class="button">КП ПОС78</a>

                        {# Кнопка PDF (скрыта) #}
                        {# <a href="{% url 'generate_commercial_offer_pdf' %}" class="button">Сформировать КП (PDF)</a> #}
                    </div>
                    {# ==================================== #}

                {% else %} {# Если выбор пуст #}
                    <p class="empty-selection-message">Ваш выбор пуст.</p>
                    {# === ИЗМЕНЕНО: ДОБАВЛЕНЫ НОВЫЕ КНОПКИ (НЕАКТИВНЫЕ) === #}
                    <div class="document-buttons">
                         {# Неактивная кнопка очистки (AJAX) #}
                         <button type="button" class="button button-clear ajax-update-button disabled" data-action="clear" title="Очистить весь выбор" onclick="return false;">Очистить выбор</button>

                         {# Неактивная основная кнопка КП (стандартная ссылка) #}
                         <a href="{% url 'generate_commercial_offer_docx' %}" class="button disabled" onclick="return false;">Сформировать КП</a>

                         {# Неактивная НОВАЯ КНОПКА для КП Учебный мир #}
                         <a href="{% url 'generate_commercial_offer_umed_docx' %}" class="button disabled" onclick="return false;">КП Учебный мир</a>

                         {# Неактивная НОВАЯ КНОПКА для КП ПОС78 #}
                         <a href="{% url 'generate_commercial_offer_pos78_docx' %}" class="button disabled" onclick="return false;">КП ПОС78</a>

                         {# Неактивная кнопка PDF (скрыта) #}
                         {# <a href="{% url 'generate_commercial_offer_pdf' %}" class="button disabled" onclick="return false;">Сформировать КП (PDF)</a> #}
                    </div>
                    {# ============================================= #}
                {% endif %}
             </div>
        </div>

    </div> {# Конец div.catalog-container #}

    {# Передаем URL из Django в JavaScript - ДОЛЖЕН БЫТЬ ДО catalog_script.js #}
    <script>
        const UPDATE_SELECTION_URL = "{% url 'update_selection' %}";
        const CATALOG_SELECTION_URL = "{% url 'catalog_selection' %}";
        // Можно добавить URL'ы генерации документов, если они нужны в JS по какой-то причине,
        // но сейчас они используются напрямую в href ссылок.
        // const GENERATE_DOCX_URL = "{% url 'generate_commercial_offer_docx' %}";
    </script>

    {# Подключаем ваш JavaScript файл #}
    <script src="{% static 'js/catalog_script.js' %}"></script>

{% endblock %}